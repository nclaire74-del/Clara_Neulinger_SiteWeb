<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Viewer 3D - Marmoset</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #2c3e50;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #ecf0f1;
        }
        
        .viewer-container {
            width: 100%;
            height: 600px;
            background: #34495e;
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border: 3px solid #3498db;
        }
        
        .status {
            padding: 15px;
            background: #34495e;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .success { background: #27ae60; }
        .error { background: #e74c3c; }
        .warning { background: #f39c12; }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn.success {
            background: #27ae60;
        }
        
        .info {
            background: #34495e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #3498db;
            border-top: 4px solid #ecf0f1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Test Viewer 3D Marmoset - Clara Neulinger</h1>
        
        <div class="status" id="status">
            Initialisation du viewer 3D...
        </div>
        
        <div class="controls">
            <button class="btn" onclick="testMarmosetAvailability()">üîç Tester Marmoset</button>
            <button class="btn" onclick="loadViewer()">üöÄ Charger le Viewer</button>
            <button class="btn" onclick="reloadScript()">üîÑ Recharger Script</button>
            <button class="btn" onclick="showFileInfo()">üìã Info Fichier</button>
        </div>
        
        <div class="viewer-container" id="viewer-container">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Chargement du mod√®le 3D...</div>
            </div>
        </div>
        
        <div class="info">
            <h3>üìù Informations du Test</h3>
            <div id="info-content">
                <p><strong>Fichier 3D :</strong> assets/images/Cirucs/ok.mview</p>
                <p><strong>Type :</strong> Marmoset Viewer Scene</p>
                <p><strong>Status :</strong> <span id="viewer-status">En attente...</span></p>
                <p><strong>Derni√®re action :</strong> <span id="last-action">Aucune</span></p>
            </div>
        </div>
        
        <div class="info">
            <h3>üõ†Ô∏è Debug Console</h3>
            <div id="debug-console" style="background: #2c3e50; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
                [INIT] Test viewer initialis√©<br>
            </div>
        </div>
    </div>

    <!-- Marmoset Viewer Script -->
    <script src="js/marmoset.js"></script>

    <script>
        let viewerLoaded = false;
        const mviewFile = 'assets/images/Cirucs/ok.mview';
        
        function updateStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            
            document.getElementById('last-action').textContent = new Date().toLocaleTimeString() + ' - ' + message;
            addToDebug(`[${new Date().toLocaleTimeString()}] ${message}`);
        }
        
        function addToDebug(message) {
            const console = document.getElementById('debug-console');
            console.innerHTML += message + '<br>';
            console.scrollTop = console.scrollHeight;
        }
        
        function updateViewerStatus(status) {
            document.getElementById('viewer-status').textContent = status;
        }
        
        function testMarmosetAvailability() {
            updateStatus('Test de disponibilit√© Marmoset...', '');
            
            if (typeof marmoset !== 'undefined') {
                if (marmoset.embed) {
                    updateStatus('‚úÖ Marmoset Viewer disponible et fonctionnel !', 'success');
                    updateViewerStatus('Marmoset disponible');
                    addToDebug('[OK] marmoset.embed() d√©tect√©');
                    addToDebug('[OK] Version: ' + (marmoset.version || 'inconnue'));
                } else {
                    updateStatus('‚ö†Ô∏è Marmoset charg√© mais embed() non disponible', 'warning');
                    updateViewerStatus('Marmoset partiel');
                    addToDebug('[WARNING] marmoset existe mais pas embed()');
                }
            } else {
                updateStatus('‚ùå Marmoset Viewer non disponible', 'error');
                updateViewerStatus('Non disponible');
                addToDebug('[ERROR] Variable marmoset non d√©finie');
            }
        }
        
        function loadViewer() {
            updateStatus('Chargement du viewer 3D...', '');
            
            if (typeof marmoset === 'undefined' || !marmoset.embed) {
                updateStatus('‚ùå Marmoset non disponible - Impossible de charger', 'error');
                return;
            }
            
            const container = document.getElementById('viewer-container');
            const loading = document.getElementById('loading');
            
            try {
                // Nettoyer le container
                container.innerHTML = '';
                
                // Remettre le loading
                container.appendChild(loading);
                
                addToDebug(`[LOAD] Chargement de: ${mviewFile}`);
                
                // Cr√©er le viewer Marmoset
                const viewer = marmoset.embed({
                    src: mviewFile,
                    id: 'circus-viewer',
                    width: '100%',
                    height: '100%',
                    autoStart: true,
                    fullFrame: false,
                    loop: true,
                    pagePreset: true,
                    autoRotate: false,
                    showUI: true,
                    allowFullscreen: true,
                    onLoad: function() {
                        addToDebug('[SUCCESS] Viewer charg√© avec succ√®s');
                        updateStatus('‚úÖ Mod√®le 3D charg√© avec succ√®s !', 'success');
                        updateViewerStatus('Charg√© et fonctionnel');
                        
                        // Masquer le loading
                        if (loading && loading.parentNode) {
                            loading.style.display = 'none';
                        }
                        
                        viewerLoaded = true;
                    },
                    onError: function(error) {
                        addToDebug('[ERROR] Erreur de chargement: ' + error);
                        updateStatus('‚ùå Erreur lors du chargement du mod√®le', 'error');
                        updateViewerStatus('Erreur de chargement');
                    }
                });
                
                // Ajouter le viewer au container
                if (viewer && viewer.domElement) {
                    container.appendChild(viewer.domElement);
                    addToDebug('[OK] Viewer ajout√© au DOM');
                } else {
                    // Fallback: cr√©er un iframe
                    createIframeViewer(container);
                }
                
                // Timeout de s√©curit√©
                setTimeout(() => {
                    if (!viewerLoaded) {
                        addToDebug('[WARNING] Timeout - Le viewer met du temps √† charger');
                        updateStatus('‚è≥ Chargement en cours... (cela peut prendre du temps)', 'warning');
                    }
                }, 5000);
                
            } catch (error) {
                addToDebug('[ERROR] Exception: ' + error.message);
                updateStatus('‚ùå Erreur technique: ' + error.message, 'error');
                updateViewerStatus('Erreur technique');
            }
        }
        
        function createIframeViewer(container) {
            addToDebug('[FALLBACK] Cr√©ation d\'un iframe viewer');
            
            const iframe = document.createElement('iframe');
            iframe.src = mviewFile;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.background = '#000';
            
            iframe.onload = function() {
                addToDebug('[OK] Iframe charg√©');
                updateStatus('‚úÖ Viewer iframe charg√©', 'success');
                updateViewerStatus('Iframe actif');
            };
            
            iframe.onerror = function() {
                addToDebug('[ERROR] Erreur iframe');
                updateStatus('‚ùå Erreur iframe', 'error');
            };
            
            container.appendChild(iframe);
        }
        
        function reloadScript() {
            updateStatus('Rechargement du script Marmoset...', '');
            
            // Supprimer l'ancien script
            const oldScript = document.querySelector('script[src="js/marmoset.js"]');
            if (oldScript) {
                oldScript.remove();
                addToDebug('[CLEAN] Ancien script supprim√©');
            }
            
            // Cr√©er un nouveau script
            const newScript = document.createElement('script');
            newScript.src = 'js/marmoset.js?v=' + Date.now();
            
            newScript.onload = function() {
                addToDebug('[OK] Script recharg√© avec succ√®s');
                updateStatus('‚úÖ Script Marmoset recharg√©', 'success');
                setTimeout(() => testMarmosetAvailability(), 1000);
            };
            
            newScript.onerror = function() {
                addToDebug('[ERROR] Erreur de rechargement du script');
                updateStatus('‚ùå Erreur lors du rechargement', 'error');
            };
            
            document.head.appendChild(newScript);
        }
        
        function showFileInfo() {
            addToDebug('[INFO] V√©rification du fichier .mview');
            
            fetch(mviewFile, {method: 'HEAD'})
                .then(response => {
                    if (response.ok) {
                        addToDebug(`[OK] Fichier accessible - Taille: ${response.headers.get('content-length')} bytes`);
                        updateStatus('‚úÖ Fichier .mview accessible', 'success');
                    } else {
                        addToDebug(`[ERROR] Fichier non accessible - Status: ${response.status}`);
                        updateStatus('‚ùå Fichier .mview non trouv√©', 'error');
                    }
                })
                .catch(error => {
                    addToDebug(`[ERROR] Erreur de v√©rification: ${error.message}`);
                    updateStatus('‚ùå Erreur de v√©rification du fichier', 'error');
                });
        }
        
        // Auto-test au chargement
        window.onload = function() {
            updateStatus('Test viewer initialis√©', 'success');
            addToDebug('[INIT] Page charg√©e, d√©but des tests');
            
            setTimeout(() => {
                testMarmosetAvailability();
            }, 1000);
            
            setTimeout(() => {
                showFileInfo();
            }, 2000);
        };
    </script>
</body>
</html>